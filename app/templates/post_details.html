{% extends 'base.html' %}
{% block content %}


<div class="container">
    <div class="row">
        <!--Blog post Content Column-->
        <div class="col-sm-8">
            <!--blog post-->
            <!--Title-->
            <h2>{{ post.description }}  <small>(<span id="total-vote">{{ total_votes }}</span> people have voted on this)</small></h2>

            <!--Author-->
            <p class="lead">by <a href="/home/user/{{ post.author.user_id }}">{{ post.author.user_name }}</a>
                <img src="{{ post.author.profile_pic}}" class="img-responsive">
            </p>

            <hr>

            <!--Date/Time -->
            <p><span class="glyphicon glyphicon-time"></span>Posted on {{ post.timestamp }}</span></p>

            <hr>

                <!-- Only the author can see the delete post button-->
            {% if session.get('loggedin', None) %}
            {% if post.author_id == session['loggedin'] %}
            <form action="/home/post/{{ post.post_id }}/delete" method="post">
                <input type="submit" value="Delete post" id="delete-post" class="btn btn-default">
            </form>
            {% endif %}
            {% endif %}


             <!-- Your share button code -->
            <div class="fb-share-button" data-href="https://developers.facebook.com/docs/plugins/" data-layout="button-count">
                <button type="button" id="fb-share" class="btn btn-default">Share the post to facebook</button>
            </div>


                {% if post.file_name %}
                <img src="https://s3-us-west-2.amazonaws.com/opinionated/{{post.file_name}}" alt="{{ post.description }}" \
                     width="300px" height="auto">
                {% endif %}

            Tags:
            {% for tag in tag_names %}
            <a href="/home/tag/{{ tag }}">{{ tag }}</a>
            {% endfor %}

            <div class="row">
                <form action="/home/post/{{ post.post_id }}/refresh" method="post" id="vote-form">

                    {% for choice in choices %}
                    <div class="col-sm-6">
                        {% if choice.choice_text and choice.file_name %}
                        <input type="radio" name="choice_id" value="{{ choice.choice_id }}" class="choice">

                        {{ choice.choice_text }}
                        <img src="https://s3-us-west-2.amazonaws.com/opinionated/{{choice.file_name}}"
                                 alt="{{ choice.choice_text }}" width="300px" height="auto">


                        {% elif choice.file_name %}
                        <input type="radio" name="choice_id" value="{{ choice.choice_id }}" class="choice">
                            <img src="https://s3-us-west-2.amazonaws.com/opinionated/{{choice.file_name}}"
                                 alt="{{ choice.file_name }}" width="300px" height="auto">
                        {% else %}
                        <input type="radio" name="choice_id" value="{{ choice.choice_id }}" class="choice">

                        {{ choice.choice_text }}
                        {% endif %}

                        <div>
                            number of votes: <span id="vote-count-{{ choice.choice_id }}">{{ vote_dict[choice.choice_id] }}</span>
                            <span id="vote-count-percent-{{choice.choice_id}}"></span>
                            {% if total_votes > 0 %}
                            <span class="vote-count-percent">Percentage: {{ vote_dict[choice.choice_id]/ total_votes }}</span>
                            {% else %}
                            <p class="no-vote">No one has vote yet</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}

                    <input type="submit" value="Vote" id="submit-vote" class="btn btn-default">
                </form>
            </div>
        </div>
    </div>


    <div id="donutchart" style="width: 500px; height: 300px;"></div>
    <div id="mapchart_div" style="width: 500px; height: 300px;"></div>

     <nav>
        <ul class="pager">
            <li><a href="javascript:" onclick="previousPost({{ post.post_id }}, {{ post_ids }})">previous</a></li>
            <li><a href="javascript:" onclick="nextPost({{ post.post_id }}, {{ post_ids }})">next</a></li>
        </ul>
    </nav>

    <!--Blog Comments-->
    <!-- Comments Form-->
    <div class="well">
         <h3>Comments</h3>
        <form action="/home/post/{{post.post_id}}/comment/refresh" method="post" id="comment-form" role="form">
            <div class="form-group">
                <textarea rows="3" name="new_comment" id="comment-content" class="form-control"></textarea>
                <br>
            </div>
            <input id="comment-submit-button" type="submit" class="btn btn-default">
        </form>
    </div>
    <hr>
    <!--Posted Comments-->

    <!--Comment-->
    <ul class="comments">
        <div class="media">
            {% if comments %}
            {% for comment in comments %}
            <a href="/home/user/{{ comment.user_id }}" class="pull-left"><img src="{{comment.user.profile_pic}}"></a>
            <div class="media-body">
                <h4 class="media-heading"><a href="/home/user/{{ comment.user_id }}">{{ comment.user.user_name }}</a>  <small>{{ comment.timestamp}}</small></h4>
                {{ comment.content }}
            </div>
                {% if session.get('loggedin', None) %}
                {% if comment.user_id == session['loggedin'] %}
                <div id="server-delete">
                    <form action="/home/comment/{{ comment.comment_id }}/delete" method="post">
                        <input type="submit" value="Delete comment" class="delete-comment btn btn-default btn-xs">
                    </form>
                </div>
                {% endif %}
                {% endif %}
            <hr>
            {% endfor %}

            {% else %}
            <p id="no-comment">Oops, looks like no one has commented yet</p>
            {% endif %}
        </div>
    </ul>
</div>



<script src="https://code.jquery.com/jquery.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script>


    var chart_dict = {{ chart_dict | safe }}; // added the safe to escape the single quote of string
    function generate_chart_data(chart_dict) {
        var chart_votes = [['Choice', 'Votes']];
        for (var key in chart_dict) {
            chart_votes.push([key.toString(), chart_dict[key]]);
        }
        return chart_votes;
    }


    function drawChart(chart_dict_remote) { // the chart_dict_remote is an optional variable if not provided it will take the global variable
        // the one from jinja, if provided when updating with ajax, it will use that

        var title = "{{ post.description|safe }}";
        var chart_votes = null;
        if (typeof chart_dict_remote === "undefined") {
            chart_votes = generate_chart_data(chart_dict);
        } else {
            chart_votes = generate_chart_data(chart_dict_remote);
        }


        var data = google.visualization.arrayToDataTable(chart_votes);

        var options = {
            title: title,
            pieHole: 0.4,
        };

        var chart = new google.visualization.PieChart(document.getElementById('donutchart'));
        chart.draw(data, options);
    }


//    function drawMarkersMap(chart_dict_remote) {
//        var data = google.visualization.arrayToDataTable([
//
//
//        var options = {
//            region: 'world',
//            displayMode: 'markers',
//            colorAxis: {colors: ['red', 'blue']}
//        };
//
//        var chart = new google.visualization.GeoChart(document.getElementById('mapchart_div'));
//        chart.draw(data, options);
//    }
//
    google.load("visualization", "1", {packages: ["corechart", "geochart"]});
    google.setOnLoadCallback(function () {
                if ({{ total_votes }} > 0) {
        //don't show the chart unless someone has already voted on it
        drawChart();
        // drawMarkersMap();
    }
    });


    function handleComments(evt) {
        evt.preventDefault();
        var formInputs = {comment: $("#comment-content").val()};
        $.post('/home/post/{{post.post_id}}/comment/refresh', formInputs, function (result) {
            console.log(result.has_delete_button);
            console.log(typeof(result.has_delete_button));

            var pic = "<div class='media'><a href='/home/user/" + result.user_id + "' class='pull-left'><img src='" + result.user_pic + "'></a>";
            var author = "<div class='media-body'><h4 class='media-heading'><a href=''/home/user/" + result.user_id + "'>" + result.user_name +
                    "</a> <small>" + result.comment_timestamp + "</small></h4>" + result.content + "</div>";

                    '<h4 class="media-heading"><a href="/home/user/' + result.user_id + '">' + result.user_name + '</a>'
            var form = '<form action="/home/comment/' + result.comment_id + '/delete" method="post">' +
                    '<input type="submit" value="Delete comment" class="delete-comment btn btn-default btn-xs">' + '</form> <hr></div>';

            $('.comments').append(pic + author + form);
            $('#no-comment').empty();
            $('#comment-content').val('');
        })
    }
    $('#comment-form').on('submit', handleComments);


    function sharePostonFB(evt) {
        $.post('/home/post/{{post.post_id}}/share', {}, function (result) {
            alert(result);
        });
    }
    $('#fb-share').on('click', sharePostonFB);


    function handleVote(evt) {
        evt.preventDefault();

        var formInputs = {choice_id: $('input[type="radio"][name="choice_id"]:checked').val()};

        $.post('/home/post/{{post.post_id}}/refresh', formInputs, function (result) {
            var compare = JSON.parse(result) !== "undefined";
            if (compare) {
                result = JSON.parse(result);

                var vote_count = result[0];
                var vote_count_percent = result[1];
                var total_votes = result[2];
                var chart_dict = result[3];

//            var chart_votes = [["choice", "votes"]];

                for (var choice_id in vote_count) {
                    $('#vote-count-' + choice_id).html(vote_count[choice_id].toString());
                    $('.no-vote').empty();

                }
//            for (var choice_text in chart_dict) {
//                chart_votes.push([choice_text, chart_dict[choice_text]]);
//            }

//                function chart_votes(chart_vote);

                for (var choice_id in vote_count_percent) {

                    $('#vote-count-percent-' + choice_id).html("percentage:" + vote_count_percent[choice_id].toString());
                    $('.vote-count-percent').empty();
                }
                $('#total-vote').html(total_votes.toString());
                drawChart(chart_dict);
            } else {
                alert('Please log in to vote');
            }
        });

    }

    $('#vote-form').on('submit', handleVote);


    function deletePost(evt) {
        confirm("Are you sure you want to delete the post");

    }

    $('#delete-post').on('click', deletePost);

    function deleteComment(evt) {
        confirm("Are you sure you want to delete the comment");

    }

    $('.delete-comment').on('click', deleteComment);


    function previousPost(post_id, post_ids) {
        var idx = post_ids.indexOf(post_id);
        if (idx > 0) {
            var previous = post_ids[idx - 1];
            location.href = previous.toString();
        } else {
            $('#previous-post').removeClass('previous').addClass('previous disabled');
//
        }

    }

    function nextPost(post_id, post_ids) {
        var idx = post_ids.indexOf(post_id);
        if (idx < post_ids.length - 1) {
            var next = post_ids[idx + 1];
            location.href = next.toString();
        } else {
            $('#next-post').removeClass('next').addClass('next disabled');
        }

    }


</script>

{% endblock %}