{% extends 'base.html' %}
{% block content %}

<a href="/home">Home</a>

<ul class="posts">

    <li class="posts">
        <div>
            <a href="/home/user/{{ post.author.user_id }}">{{ post.author.user_name }}</a>
        </div>
        {{ post.description }} (<span id="total-vote">{{ total_votes }}</span> people have voted on this)
    <form action="/home/post/{{ post.post_id }}/refresh" method="post" id="vote-form">

            {% for choice in choices %}

                {% if choice.text_choice and choice.file_name %}
                     <input type="radio" name="vote" value="{{ choice.choice_id }}" class="choice">
                     <div>{{ choice.text_choice }}</div>
                     <div>
                         <img src="https://s3-us-west-2.amazonaws.com/opinionated/{{hash_files[choice]}}" alt="{{ choice.file_name }}" width="300px" height="auto">
                     </div>

                {% elif choice.file_name %}
                     <input type="radio" name="vote" value="{{ choice.choice_id }}" class="choice">
                     <div>
                         <img src="https://s3-us-west-2.amazonaws.com/opinionated/{{hash_files[choice]}}" alt="{{ choice.file_name }}" width="300px" height="auto">
                     </div>
                {% else  %}
                     <input type="radio" name="vote" value="{{ choice.choice_id }}" class="choice">
                     <div>{{ choice.text_choice }}</div>
                {% endif %}

                <div>
                    number of votes: <span id="vote-count-{{ choice.choice_id }}">{{ vote_dict[choice.choice_id] }}</span>
                {% if total_votes != 0 %}
                    percentage: <span id="vote-count-percent-{{choice.choice_id}}">{{ vote_dict[choice.choice_id]/ total_votes }}</span>
                {% else %}
                   <p>No one has voted yet</p>
                {% endif %}
                </div>
            {% endfor %}


    <input type="submit" value="Vote">
    </form>
    </li>
</ul>

<h3>Comments</h3>
<form action="/home/post/{{post.post_id}}/comment/refresh" method="post" id="comment-form">
    <textarea rows="4" cols="100" name="new_comment" id="comment-content"></textarea>
    <br>
    <input id="comment-submit-button" type="submit">
</form>

<ul class="comments">
    {% if comments %}
        {% for comment in comments %}
        <li>
            <a href="/home/user/{{ comment.user_id }}">{{ comment.user.user_name }}</a>:
            {{ comment.content }}
        </li>
        {% endfor %}

    {% else %}
        <p>Oops, looks like no one has commented yet</p>
    {% endif %}

</ul>


<script src="https://code.jquery.com/jquery.js"></script>
<script>
    function handleComments(evt) {
        evt.preventDefault();
        var formInputs = {comment: $("#comment-content").val()};
        $.post('/home/post/{{post.post_id}}/comment/refresh', formInputs, function (result) {
            $('.comments').append('<li><a href="/home/user/'+ result.user_id + '">'+ result.user_name + '</a>:'+ result.content + '</li>')
        })
    }
$('#comment-form').on('submit', handleComments);

    function handleVote(evt) {
        evt.preventDefault();
        var formInputs = {vote: $('input[type="radio"][name="vote"]:checked').val()};
        console.log(formInputs)
        $.post('/home/post/{{post.post_id}}/refresh', formInputs, function (result) {

            result = JSON.parse(result);

            var vote_count = result[0];
            var vote_count_percent = result[1];
            var total_vote = result[2];

            for (var choice_id in vote_count) {
                $('#vote-count-'+choice_id).html(vote_count[choice_id].toString());
            }
            for (var choice_id in vote_count_percent) {
                $('#vote-count-percent-'+choice_id).html(vote_count_percent[choice_id].toString());
            }
            $('#total-vote').html(total_vote.toString());
        })
    }
$('#vote-form').on('submit', handleVote);



</script>

{% endblock %}